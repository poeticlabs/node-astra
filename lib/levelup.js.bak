// command: levelup

module.exports = function ( data, args ) {

	var identee = null;

	if ( args.length > 0 ) {

		identee = args[0];

		Identity.findOne( {
			where: {
				or: [ {user: identee}, {xo: identee}, {nick: identee} ]
			}
		}, function ( err, user ) {
			if ( user ) {
				data.identity = user;
				identee = user.user;
			} else {
				return "Sorry, " + data.author + ", I'm unable to level up an unidented user.";
			}
		});

	} else {
		identee = data.author;
	}

	for ( var i = 0; i < sails.config.ranks.length; i++ ) {
		var rank = sails.config.ranks[i];
		if ( data.identity.level <= rank.max_level && data.identity.level >= rank.min_level ) {
			data.rank_max_level = rank.max_level;
			data.rankname = rank.name;
		}
	}

	var new_level = ++data.identity.level;
	if ( new_level > data.rank_max_level ) {
		return identee + " is at the max level for rank: " + data.rankname
		+ ", and cannot level any further without being promoted first.";
	}

	//update user
	Identity.update( {
		user: identee
	}, { level: new_level }, function( err, users ) {
		if ( err ) {
			console.log( JSON.stringify(err).error );
			data.response = JSON.stringify(err);
			sails.controllers.message.send( data );
		} else if ( users ) {
			data.response = "Identity " + users[0].user + " updated.";
			sails.controllers.message.send( data );
			//
			data.target = identee;
			data.response = "Congratulations! You have gained a level and are now " + data.rankname + ", lv. " + new_level;
			sails.controllers.message.send( data );
		} else {
			data.response = "Something seems strange about this...";
			sails.controllers.message.send( data );
		}
	});

}

module.exports.help = {
	levelup: 'levelup\t[user]\n\tIncrease a user\'s ident level by one, as limited by rank.\n'
	+ 'Omit [user] for self.'
}
